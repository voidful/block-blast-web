*,*::before,*::after{ box-sizing:border-box; min-width:0; }

/* --- CSS 變數 --- */
:root{
  --vh: 1svh;

  /* 棋盤 */
  --grid-size: 8;
  --board-size: 560px;
  --gap: 6px;
  --tile-radius: 9px;

  /* 托盤/暫存槽（固定槽位、高度固定，候選縮放） */
  --tray-cell: 30px;
  --tray-slot-h: calc(var(--tray-cell) * 3.4 + 24px);
  --hold-slot-h:  calc(var(--tray-cell) * 2.6 + 16px);
  --tray-fill: 0.94;
  --tray-scale-max: 1.8;

  /* 顏色 */
  --bg: #0e1122;
  --panel: #151a2f;
  --text: #eef2ff;
  --muted: #a3acd6;
  --accent: #7aa2ff;

  /* 動畫 */
  --dur-pop:.14s; --dur-place:.16s; --dur-clear:.26s; --dur-toast:.8s;
  --ease-out:cubic-bezier(.22,.61,.36,1);
  --ease-back:cubic-bezier(.34,1.56,.64,1);
}
@media (prefers-reduced-motion: reduce){
  :root{ --dur-pop:.06s; --dur-place:.08s; --dur-clear:.12s; --dur-toast:.5s; }
}

/* --- 版面 --- */
html,body{ width:100%; height:100%; overflow:hidden; overscroll-behavior:none; }
@supports (height:100svh){ html,body{ height:100svh; } }
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, "PingFang TC","Noto Sans TC","Microsoft JhengHei", Arial, sans-serif;
  background: radial-gradient(1200px 800px at 70% -20%, #1b2247 0%, var(--bg) 60%);
  color:var(--text);
  display:grid; place-items:center;
  background-attachment:fixed;
}
body.is-fever .board{
  box-shadow:0 20px 60px rgba(0,0,0,.45),
             inset 0 0 0 1px #2a2f55,
             inset 0 0 24px rgba(255,193,101,.28);
}

.app{
  width:min(1200px,96vw);
  height:calc(var(--vh)*100);
  overflow:hidden;
  display:grid;
  grid-template-columns:1fr minmax(0,var(--board-size)) 1fr;
  grid-template-areas:
    "header header header"
    ". board ."
    ". hold ."
    ". tray ."
    ". help .";
  grid-template-rows:auto auto auto auto auto;
  gap:16px;
  padding:16px 0 calc(16px + env(safe-area-inset-bottom));
}
@supports (height:100svh){ .app{ height:100svh; } }

header{
  grid-area:header; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 8px; flex-wrap:wrap;
  min-height:56px;
}
.brand{ display:flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.3px; color:#cfe1ff }
.brand .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px rgba(122,162,255,.6) }

.scorebox{ display:flex; gap:18px; align-items:baseline; flex-wrap:wrap }
.label{ color:var(--muted); font-size:12px }
.value{ font-size:22px; font-weight:800 }

.fever{ display:flex; align-items:center; gap:8px; min-width:180px; }
.fever-label{ font-weight:800; font-size:12px; letter-spacing:1px; color:#ffd08a }
.fever-bar{
  position:relative; width:170px; height:10px;
  background:#0f1528; border:1px solid #5b3b16; border-radius:999px;
  overflow:hidden; box-shadow:0 0 10px rgba(255,193,101,.25) inset;
}
/* transform 版＝不重排 */
.fever-bar>i{ display:block; height:100%; width:100%; transform-origin:left center; transform:scaleX(var(--fever,0)); background:linear-gradient(90deg,#ffce6b,#ff7aa5); transition:transform .15s; }
.fever-sweep{
  position:absolute; top:-60%; bottom:-60%;
  background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,236,180,.9),rgba(255,255,255,0));
  filter:blur(3px); mix-blend-mode:screen; opacity:.9; pointer-events:none;
}

.combo{ display:flex; align-items:center; gap:8px; width:210px; flex:0 0 210px; }
.combo .tag{
  display:inline-block; min-width:120px; text-align:center;
  font-weight:800; font-size:14px; color:#c8ffe6; background:#16352a;
  border:1px solid #2a5f4b; padding:4px 8px; border-radius:999px;
  transform-origin:left center; transition: transform .12s var(--ease-back), opacity .12s var(--ease-out), visibility 0s linear .12s;
  visibility:hidden; opacity:0;
}
.combo .tag.show{ visibility:visible; opacity:1; transition-delay:0s; }
.combo .bar{ width:120px; height:8px; background:#0f1528; border:1px solid #27305b; border-radius:999px; overflow:hidden }
.combo .bar>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#3ef0b4,#7aa2ff); transition:width .15s var(--ease-out) }

.controls{ display:flex; gap:8px; flex-wrap:wrap }
button{
  background:linear-gradient(180deg,#2a335f,#1b2143);
  border:1px solid #2c376a;
  color:var(--text);
  padding:10px 12px;
  border-radius:10px; cursor:pointer; font-weight:700;
}
button.secondary{ background:#161c3c; border-color:#2a3568; color:#d7defa }
button.ghost{ background:transparent; border-color:#2a3568 }
.stars{ min-width:72px; text-align:right; color:#ffe28a; font-weight:800 }

/* --- 棋盤 --- */
.board-wrap{ grid-area:board; position:relative; display:grid; place-items:center; border-radius:16px; overflow:visible; }
.board{
  width:var(--board-size); height:var(--board-size);
  background:linear-gradient(180deg,#12152a,#0d1021);
  border-radius:16px; padding:var(--gap);
  display:grid; grid-template-columns:repeat(var(--grid-size),1fr); grid-template-rows:repeat(var(--grid-size),1fr);
  gap:var(--gap); position:relative;
  box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px #2a2f55;
  contain:layout paint size;
}
.cell{ position:relative; background:#141837; border-radius:calc(var(--tile-radius) - 2px); overflow:hidden; }
.cell.highlight{ outline:2px solid rgba(122,162,255,.85); outline-offset:-2px; box-shadow:0 0 0 2px rgba(122,162,255,.25) inset; }

.tile{ position:absolute; inset:0; border-radius:var(--tile-radius); transform:scale(0.98); transition:transform var(--dur-place) var(--ease-out); box-shadow:inset 0 -2px 0 rgba(0,0,0,.25); }
.tile::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(0,0,0,.08)); border-radius:inherit; pointer-events:none }
.tile.appear{ animation:pop var(--dur-pop) var(--ease-back) }
@keyframes pop{ from{transform:scale(.2); opacity:0} to{transform:scale(0.98); opacity:1} }
.tile.clearing{ animation:clear var(--dur-clear) var(--ease-out) forwards }
.tile.clearing[data-delay]{ animation-delay:var(--delay) }
@keyframes clear{ 50%{transform:scale(.85)} to{transform:scale(.1); opacity:0} }

.ghost-layer,.fx-layer{ position:absolute; left:0; top:0; width:0; height:0; pointer-events:none; contain:layout paint size; }
.ghost-cell{ position:absolute; border-radius:var(--tile-radius); opacity:.6; box-shadow:0 0 0 2px rgba(74,222,128,.9) inset; background:rgba(74,222,128,.14) }
.ghost-invalid{ box-shadow:0 0 0 2px rgba(255,122,122,.85) inset; background:rgba(255,122,122,.12) }

/* --- Hold & Tray --- */
.hold-row{
  grid-area:hold;
  width:var(--board-size);
  margin:0 auto;
  display:grid;
  grid-template-columns:auto 1fr auto auto auto;
  align-items:center; gap:10px; color:var(--muted);
  padding:0 8px;
}
.hold-label{ font-weight:800; letter-spacing:.3px; color:#cfe1ff }
.hold-slot{
  background:var(--panel); border:1px solid #22284a; border-radius:14px;
  height:var(--hold-slot-h); min-height:var(--hold-slot-h); position:relative; overflow:hidden;
}
.tray{
  grid-area:tray;
  display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px;
  width:var(--board-size); margin:0 auto 0;
}
.slot{
  background:var(--panel); border-radius:14px; padding:10px; border:1px solid #22284a;
  position:relative; height:var(--tray-slot-h); min-height:var(--tray-slot-h); max-height:var(--tray-slot-h);
  overflow:hidden; display:block;
}
.slot.empty::after{ content:"拖曳方塊到棋盤"; color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:90%; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
.slot.hint{ box-shadow:0 0 0 2px #4ade80 inset }

@keyframes trayPulse {
  0%,100% { opacity:.65; transform:scale(1); filter: drop-shadow(0 0 10px rgba(255,160,122,.35)); }
  50%     { opacity:1;   transform:scale(1.02); filter: drop-shadow(0 0 20px rgba(255,160,122,.7)); }
}
body.is-fever .tray .slot::after{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background: radial-gradient(160px 42px at 50% 100%, rgba(255,193,101,.22), transparent 70%);
  animation: trayPulse 1.1s ease-in-out infinite;
}

/* slot → pwrap(relative) → pinner(abs center) → piece(scale) */
.pwrap{ position:relative; width:100%; height:100%; overflow:hidden; }
.pinner{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%) scale(var(--mag,1));
  transition: transform .12s var(--ease-back), filter .12s var(--ease-out);
  display:grid; place-items:center;
}
.slot.hover-mag .pinner{ --mag:1.03; filter: drop-shadow(0 6px 14px rgba(0,0,0,.34)); }
.slot:hover .pinner{ --mag:1.03; filter: drop-shadow(0 6px 14px rgba(0,0,0,.34)); }

.piece{ display:grid; gap:4px; grid-auto-rows:var(--tray-cell); grid-auto-columns:var(--tray-cell); touch-action:none; cursor:grab; transform-origin:center center; will-change:transform }
.piece:active{ cursor:grabbing }
.piece.grabbed{ transform:scale(1.06) rotate(-1.2deg); filter:drop-shadow(0 10px 20px rgba(0,0,0,.35)); transition:transform .08s var(--ease-back) }
.cell-mini{ width:var(--tray-cell); height:var(--tray-cell); border-radius:7px; box-shadow:inset 0 -2px 0 rgba(0,0,0,.25) }

/* --- Dialog/Toast --- */
.overlay{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(5,6,16,.68); backdrop-filter:blur(2px); opacity:0; pointer-events:none; transition:opacity .15s var(--ease-out) }
.overlay.show{ opacity:1; pointer-events:auto }
.dialog{ background:linear-gradient(180deg,#20264b,#171c3a); border:1px solid #303b74; border-radius:14px; padding:20px 18px; text-align:center; width:min(90vw,480px); box-shadow:0 20px 60px rgba(0,0,0,.5); max-height:min(86svh,520px); overflow:auto }
.dialog h2{ margin:4px 0 6px }
.dialog p{ margin:6px 0 14px; color:var(--muted) }

.toasts{ position:absolute; inset:0; pointer-events:none }
.toast{ position:absolute; transform:translate(-50%,-50%) translateY(0px); font-weight:900; color:#fff; text-shadow:0 2px 12px rgba(0,0,0,.4); animation:toast var(--dur-toast) var(--ease-out) forwards; }
@keyframes toast{ from{opacity:0; transform:translate(-50%,-50%) translateY(10px) scale(.94)} 20%{opacity:1} to{opacity:0; transform:translate(-50%,-80%) scale(1.06)} }

.star-fly{ position:fixed; left:0; top:0; pointer-events:none; z-index:10000; will-change:transform,opacity; font-size:18px; filter:drop-shadow(0 0 6px rgba(255,200,90,.7)); }

/* --- Help --- */
.help{ grid-area:help; width:var(--board-size); margin:0 auto; color:var(--muted); font-size:13px; line-height:1.6; content-visibility:auto; contain-intrinsic-size:400px; }

/* --- 低 FPS 降噪 --- */
body.lowfx .board{ box-shadow:0 12px 32px rgba(0,0,0,.35), inset 0 0 0 1px #2a2f55 }
body.lowfx .tile{ box-shadow:inset 0 -1px 0 rgba(0,0,0,.2) }
body.lowfx .tile::after{ background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.03)) }
body.lowfx .slot:hover .pinner{ --mag:1.01; filter:none }

/* --- 直向手機 --- */
@media (max-width:900px) and (orientation:portrait), (max-aspect-ratio:3/4){
  :root{ --board-size:min(70svh,94vw); --tray-cell:clamp(22px,7.2vmin,34px); --gap:5px; --tile-radius:8px; }
  .app{
    width:100vw;
    grid-template-columns:1fr;
    grid-template-areas:"header" "board" "hold" "tray" "help";
    gap:10px; padding:8px 0 calc(10px + env(safe-area-inset-bottom));
  }
  header{ align-items:stretch; justify-content:flex-start; gap:6px; padding:0 10px; row-gap:8px; display:grid; grid-template-columns:1fr 1fr; min-height:unset; }
  .controls{ grid-column:1/-1; width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; white-space:nowrap; gap:6px; padding:6px 0; scrollbar-width:none }
  .controls::-webkit-scrollbar{ display:none }
  .controls>button{ padding:8px 10px; font-size:12px; border-radius:9px }
  .help{ display:none }
}

/* --- 橫向：左右 35%（總寬 70%） --- */
@media (min-aspect-ratio: 5/4) and (min-width: 900px){
  .app{
    width:100vw;
    height:calc(var(--vh)*100);
    grid-template-columns: var(--side-w) var(--side-w);
    grid-template-areas:
      "header header"
      "hold   board"
      "tray   board"
      "help   board";
    grid-template-rows: auto 1fr auto auto;
    gap:18px 24px;
    justify-content:center;
    padding:14px 18px calc(14px + env(safe-area-inset-bottom));
  }
  .hold-row, .tray, .help{ width:var(--side-w); margin:0; }
  .board-wrap{ align-self:center; justify-self:center; }
  .help{ display:block; }
}

/* 讓遊戲接手手勢 */
html,body,.app,.board-wrap,.board,.slot,.hold-slot,.piece{ touch-action:none }

/* 拖曳代理：固定定位 + 陰影 + 對齊左上角（由 JS 控制偏移） */
.drag-proxy,
.guide-proxy{
  position: fixed;
  left: 0; top: 0;
  pointer-events: none;
  z-index: 10000;
  will-change: transform;
  transform-origin: top left;
  filter: drop-shadow(0 12px 22px rgba(0,0,0,.35));
}
.drag-proxy .cell-mini,
.guide-proxy .cell-mini{ border-radius: 7px; }
.drag-proxy{ transform-origin: top left; }
/* FX 畫布清晰一些（已存在就可略過） */
.fx-layer{ image-rendering: optimizeQuality; }